<!DOCTYPE html>
<html lang="zxx" class="no-js">
   <meta charset="utf-8">
	<head>
		<!-- Mobile Specific Meta -->
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<!-- Favicon-->
		<link rel="shortcut icon" href="img/fav.png">
		<!-- Author Meta -->
		<meta name="author" content="codepixer">
		<!-- Meta Description -->
		<meta name="description" content="">
		<!-- Meta Keyword -->
		<meta name="keywords" content="">
		<!-- meta character set -->
		<meta charset="UTF-8">
		<!-- Site Title -->
		<title>Iraq and Syria wars</title>

		<link href="https://fonts.googleapis.com/css?family=Poppins:100,200,400,300,500,600,700" rel="stylesheet"> 
			<!--
			CSS
			============================================= -->
			<link rel="stylesheet" href="css/linearicons.css">
			<link rel="stylesheet" href="css/font-awesome.min.css">
			<link rel="stylesheet" href="css/bootstrap.css">
			<link rel="stylesheet" href="css/magnific-popup.css">
			<link rel="stylesheet" href="css/nice-select.css">					
			<link rel="stylesheet" href="css/animate.min.css">
			<link rel="stylesheet" href="css/owl.carousel.css">
            <link rel="stylesheet" href="css/main.css">
            <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

		
		
  <style>
	div.titre1553 {	
    position: relative;			
    text-align: center;	
    color: black;
    font-size: 19px;
    padding: 5px;				
    font: 19px Cursive;		
    border: 0px;		
    border-radius: 8px;			
    pointer-events: none;
    background-color:rgba(76, 175, 80, 0.3);
    left:0px;
    top:0px;}
    body { margin:0;top:0;right:0;bottom:0;left:0; }
    div.tooltip {	
    position: absolute;			
    text-align: center;	
    color: black;
    padding: 10px;				
    font: 12px sans-serif;		
    border: 0px;		
    border-radius: 8px;			
    pointer-events: none;			
    }
    div.pieChart{
      top : 20 ;
      left:20;
      margin: auto;
    }
  </style>
</head>

<body>
<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
  <script src="https://d3js.org/d3.v4.js"></script>
  <script src="https://d3js.org/topojson.v1.min.js"></script>
  <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>


			  <header id="header" id="home">
			    <div class="container">
			    	<div class="row align-items-center justify-content-between d-flex">
				      <div id="logo">
				        <a href="index.html"><img src="img/Logo_Ã‰cole_centrale_de_Lyon.svg.png" alt="" title="" width="250px" height="40px" /></a>
				      </div>
				      <nav id="nav-menu-container">
				        <ul class="nav-menu">
				          <li class="menu-active"><a href="index.html">Home</a></li>				          
				          <li><a href="Syrian_map.html">Cartography of syrian deaths</a></li>
				          <li><a href="FinalSyrie.html">Evolution of death in Syria</a></li>
				          <li><a href="FinalIrak.html">Evolution of death in Iraq</a></li>
				          <li><a href="refugies.html"> Refugees of Syria and Iraq in the world </a></li>
				          				          
				        </ul>
				      </nav><!-- #nav-menu-container -->		    		
			    	</div>
			    </div>
			  </header>
  <div style="height:300px"></div>
<div class="titre1553"> Cartography of deaths in Syria</div>
  <p>Distribution of deaths by: </p>
  <input type="radio" id="sujet1" name="sujet" value="age" checked>
  <label for="dem">Age and gender</label><br>
  <input type="radio" id="sujet2" name="sujet" value="actor">
  <label for="dep">Actor</label><br>
  <input type="radio" id="sujet3" name="sujet" value="deathcause">
  <label for="sub">Cause of death</label> 
  <script>
    var margin = {top: 20, right: 20, bottom: 30, left: 40};

	var width =500 - margin.left - margin.right,
    height = 700 - margin.top - margin.bottom;


    var container= d3.select("body").append("div").attr("class", "container-fluid").append("div")
        .attr("class","row")
   


    var div = d3.select("body").append("div")	
        .attr("class", "tooltip")				
        .style("opacity", 0);
        
    var svg = container.append("svg")
        .attr("class","col-sm-6")
        .attr("width", width +margin.left +margin.right)
        .attr("height", height +margin.top + margin.bottom)
    
     var container2 = container.append("div")
        .attr("class","col-sm-6 order-last")
        .style("over-flow","hidden")

    // svg.call(d3.zoom().on("zoom", function () {
    //    svg.attr("transform", d3.event.transform)
    // }))
        
    var svg2 = container2.append("svg")        
        .attr("width",700)
        .attr("height",600)
        

        
    
    var genders=["Adult - Male","Child - Male","Adult - Female","Child - Female","Total"];
    
    var color= d3.scaleOrdinal(d3.schemeCategory20.concat(d3.schemeTableau10) ).domain(genders)

   

    
    
  var pie = d3.pie() 
    .value(function(d) {return d.value; })

  var projection = d3.geoConicConformal().center([38,35])
  
    var data;
    var centroids;
    var ProvinceNest;
    var max ;
    var min ;
    var json;
    
	d3.json("https://raw.githubusercontent.com/lylla318/Syria_Story/master/data/syria-districts-topojson.json", function(error, jsonfile) {

        projection.scale(5000)

        var path = d3.geoPath() // d3.geo.pa,th avec d3 version 3
        .projection(projection);

        var bounds=path.bounds(topojson.feature(jsonfile, jsonfile.objects.SYR_adm2));
        json = topojson.feature(jsonfile, jsonfile.objects.SYR_adm2);
        // console.log(json);

        
    d3.csv("https://raw.githubusercontent.com/IMrabet/Syria_Iraq_Stats/master/VDC_Syria_CASREP.csv",
        function(error, datafile){
        
        parseDate = d3.timeParse("%Y-%m-%d");
        formatDate=d3.timeFormat("%Y")
        datafile.forEach(function(d){
            d.deathdate=parseDate(d.deathdate);          

        });
        data = datafile;
        // console.log(data);

        


          function visualise_data(data,json,time_start,time_end,data_nest){
            svg.html("")
            console.log("ok")
            if (data_nest=="age"){
                svg.selectAll("rect").data(genders.slice(0,4)).enter().append("rect")
                .attr("fill",function(d,i){return color(d)})
                .attr("x",function(d,i){return 10})
                .attr("y",function(d,i){return (10+i*25)})
                .attr("width",10)
                .attr("height",10)

                svg.selectAll("text").data(genders.slice(0,4)).enter().append("text")
                .attr("fill",function(d,i){return color(d)})
                .attr("x",function(d,i){return 20})
                .attr("y",function(d,i){return (20+i*25)})
                .text(function(d,i){ return d})
            
        }
            else {
                if (data_nest=="actor"){
                    dataNest= d3.nest().key(function(d){return d.actor}).entries(data).map(function(e){return e.key})
                    svg.selectAll("rect").data(dataNest).enter().append("rect")
                    .attr("fill",function(d,i){return color(d)})
                    .attr("x",function(d,i){return 10})
                    .attr("y",function(d,i){return (10+i*25)})
                    .attr("width",10)
                    .attr("height",10)

                    svg.selectAll("text").data(dataNest).enter().append("text")
                    .attr("fill",function(d,i){return color(d)})
                    .attr("x",function(d,i){return 20})
                    .attr("y",function(d,i){return (20+i*25)})
                    .text(function(d,i){ return d})
                }
                if (data_nest=="deathcause"){
                    dataNest= d3.nest().key(function(d){return d.deathcause}).entries(data).map(function(e){return e.key})
                    svg.selectAll("rect").data(dataNest).enter().append("rect")
                    .attr("fill",function(d,i){return color(d)})
                    .attr("x",function(d,i){return 10})
                    .attr("y",function(d,i){return (10+i*25)})
                    .attr("width",10)
                    .attr("height",10)

                    svg.selectAll("text").data(dataNest).enter().append("text")
                    .attr("fill",function(d,i){return color(d)})
                    .attr("x",function(d,i){return 20})
                    .attr("y",function(d,i){return (20+i*25)})
                    .text(function(d,i){ return d})
                }
        }
            Total_provinceNest = d3.nest()
                .key(function(d){
                    return d.province;
                })
                .rollup(function(k){
                    //  console.log(k)
                    var localdata={}
                    /*localdata["Adult - Male"] = 0;
                    localdata["Adult - Female"] =0 ;
                    localdata["Child - Female"] =0 ;
                    localdata["Child - Male"] =0 ;
                    k.forEach(function (d){
                    localdata[d.gender]+=1;
                    })*/
                    localdata["Total"] = "str"+k.length;
                    // console.log(localdata)
                    return localdata;
                }).entries(data)

                // console.log(provinceNest)
                //  get the max and the min of the provinces deaths
                
                var max =0;
                var min =1E9;
                Total_provinceNest.forEach(function(k,i){
                    if (max<=parseInt(k.value["Total"].substr(3),10)){
                            max = parseInt(k.value["Total"].substr(3),10);
                        }
                        if (min>=parseInt(k.value["Total"].substr(3),10)){
                            min = parseInt(k.value["Total"].substr(3),10);
                        }
                })
            
            
                
               
             // select data to show 
              data_to_visualise= data.filter(function(d){
                  return (d.deathdate>=parseDate(time_start) & d.deathdate<=parseDate(time_end))
              })
              
            //   console.log(data_to_visualise)

              provinceNest = d3.nest()
                .key(function(d){
                    return d.province;
                })
                .rollup(function(k){
                    //  console.log(k)
                    var localdata={}
                    if (data_nest=="age"){
                        localdata["Adult - Male"] = 0;
                        localdata["Adult - Female"] =0 ;
                        localdata["Child - Female"] =0 ;
                        localdata["Child - Male"] =0 ;
                        k.forEach(function (d){
                        localdata[d.gender]+=1;
                        })
                        localdata["Total"] = "str"+k.length;
                        // console.log(localdata)
                    }
                    else {
                        if (data_nest=="actor"){
                            localdata["Total"] = "str"+k.length;
                            k.forEach(function (d){
                                if (localdata[d.actor]==undefined){
                                    localdata[d.actor]=1;
                                }
                                else localdata[d.actor]+=1;
                            
                        })
                           
                        }
                        if (data_nest=="deathcause"){
                            
                            k.forEach(function (d){
                                if (localdata[d.deathcause]==undefined){
                                    localdata[d.deathcause]=1;
                                }
                                else localdata[d.deathcause]+=1;
                            
                        })
                            localdata["Total"] = "str"+k.length;
                        }
                    }
                    return localdata;
                   
                }).entries(data_to_visualise)


                //  get the max and the min of the provinces deaths
                
                var maxcolor =0;
                var mincolor =1E99;
                provinceNest.forEach(function(k,i){
                    if (maxcolor<=parseInt(k.value["Total"].substr(3),10)){
                            maxcolor = parseInt(k.value["Total"].substr(3),10);
                        }
                        if (mincolor>=parseInt(k.value["Total"].substr(3),10)){
                            mincolor = parseInt(k.value["Total"].substr(3),10);
                        }
                })               

            // console.log(prvinceNest);
            
            centroids_center= d3.nest().key(function(d){return d.properties.NAME_1})
            .rollup(function(k){
                var table=[]
                k.forEach(function(d){
                    // console.log(d)
                    // console.log(d.geometry.coordinates[0])
                    if( d.geometry.coordinates[0][0].length==2){table=table.concat(d.geometry.coordinates[0])}
                    else{table=table.concat(d.geometry.coordinates[0][0])}
                    
                })
                // console.log(k[0].properties.NAME_1);
                var localfeature={"type": "Feature","properties": {},"geometry": {"type": "Polygon", "coordinates":[table]}}
                // console.log(localfeature)
               return ({"x":path.centroid(localfeature)[0],"y":path.centroid(localfeature)[1]});
            })
            .entries(json.features)
            // console.log(centroids_center)
            // console.log(centroids_center)

            
            var regions =centroids_center.map(function(name){
                return name.key
            })
            // console.log(regions)

            var colorRegions = d3.scaleOrdinal(d3.schemePaired).domain([0,13])
            var radius = d3.scaleLinear().range([10,50]).domain([min,max])


            json.features.forEach(function(feature){
                provinceNest.forEach(function(province){
                    
                    if(feature.properties.NAME_1==province.key){
                        feature.properties["infos"] = province.value;
                        for (var k of centroids_center){
                            if (k.key==feature.properties.NAME_1){
                                feature.properties.infos["x"] = "x"+k.value.x;
                                feature.properties.infos["y"] = "y"+k.value.y;
                            }
                            
                        }
                        

                    }
                })
                // console.log(feature)
            })
        

            var g= svg.append("g");
            // console.log(json.features)
            json.features.forEach(function(feature){

                var current = g.selectAll("g")
                .data(json.features)
                .enter()
                .append("g")


                geo_path=current.append("path")
                .attr("d", path)
                //.attr("fill","orange")
                .attr("fill",function(feat){
                    // console.log(parseInt(feat.properties.infos.Total.substr(3),10));
                    return colorRegions(regions.indexOf(feat.properties.NAME_1))})
                .attr("transform","translate(-80,30)")
                


                var pie = d3.pie().value(function(d){return d.value});
                  //console.log(d3.entries(listprovinces))
                var data_ready = pie(d3.entries(feature.properties.infos))
                // console.log(data_ready)
                data_ready.forEach(function(dat){
                    dat.data["x"]=feature.properties.infos.x;
                    dat.data["y"]=feature.properties.infos.y
                    dat.data["Total"]=feature.properties.infos.Total
                    dat.data["name"]=feature.properties.NAME_1;
                });


                var pie_path = current.data(data_ready)
                    .enter()
                    .append('path')
                    .attr('d', d3.arc()
                      .innerRadius(0)
                      .outerRadius(function(d){
                        // console.log(d)
                        return(radius(parseInt(d.data.Total.substr(3),10)))
                      })
                    
                    )
                  .attr("class","circles")
                  .attr('fill', function(d){ 
                    return(color(d.data.key)) 
                  })
                  .attr("stroke", "white")
                  .attr("transform", function(d) {
                    //   console.log(d)
                      return "translate("+(parseInt(d.data.x.substr(1))-75)+","+(parseInt(d.data.y.substr(1))+30)+")"
                  })
                  geo_path.on("click",function(e){
                    svg2.transition()
                    svg2.html("")
                    .transition();
                     
                     var data_show = pie(d3.entries(e.properties.infos))
                    // console.log(data_ready)
                    // console.log(data_show)
                        data_show.forEach(function(dat){
                    dat.data["x"]=e.properties.infos.x;
                    dat.data["y"]=e.properties.infos.y
                    dat.data["Total"]=e.properties.infos.Total
                    dat.data["name"]=e.properties.NAME_1;
                });
                     svg2.selectAll("path").data(data_show).enter()
                        .append('path')
                        .attr('d', d3.arc()
                        .innerRadius(0)
                        .outerRadius(50))
                    .attr("class","circles")
                    .attr('fill', function(d){ 
                        return(color(d.data.key)) 
                    })
                    .attr("stroke", "white")
                    .attr("transform","translate("+(margin.left+50)+","+(margin.top+25*(Object.keys(data_show).length-2)/2)+")")
                    
                    svg2.append("text")
                            .text("Distribution of deaths by "+data_nest+" in : "+e.properties.NAME_1)
                            .attr("x",margin.left+110)
                            .attr("y", margin.top)

                    var keys = Object.keys(e.properties.infos);
                    // console.log(keys)
                    var index =1;
                    for (let key of keys){
                        if (key!="x" && key!="y"){
                            svg2.append("text")
                            .text(
                                function(){
                                    if (key!="Total") {return key+" : " + e.properties.infos[key];}
                                    else {return key+" : " + e.properties.infos[key].substr(3)}
                                }
                            )
                            .attr("fill",color(key))
                            .attr("x",margin.left+110)
                            .attr("y", margin.top+index*25)
                            index++;
                        }
                    
                    }
                    
                  })

                geo_path.on("mouseover",function(e){
                    svg.selectAll("path").filter(function(d){
                        if (d.properties !=undefined) {return d.properties.NAME_1==e.properties.NAME_1}
                        else return false
                    }).attr("fill","yellow")
                    div.transition()		
                    .duration(200)		
                    .style("opacity", .9)
                    .style("background","white")
                    div.html( "Region: "+ e.properties.NAME_1)	
                    .style("left", (d3.event.pageX) + "px")		
                    .style("top", (d3.event.pageY - 28) + "px");
                    
                    
                }).on("mouseout",function(e){
                    svg.selectAll("path").filter(function(d){
                        if (d.properties !=undefined) {return d.properties.NAME_1==e.properties.NAME_1}
                        else return false
                    }).attr("fill",function(feat){
                    // console.log(parseInt(feat.properties.infos.Total.substr(3),10));
                    return colorRegions(regions.indexOf(feat.properties.NAME_1))})
                    div.transition()		
                    .duration(200)		
                    .style("opacity", 0)
                })              
            }) 
            
                    
                          
}
visualise_data(data,json,"2011-01-01","2020-01-01","age")
            $('input:radio').on('change', function(e){
            var name = e.currentTarget.name,
            value = e.currentTarget.value;
            visualise_data(data,json,"2011-01-01","2020-01-01",value)
            });
})
})
// while(data==undefined || json == undefined){
// console.log("ok")
// }
// console.log(data);
// console.log(json);

</script>
<script src="js/vendor/jquery-2.2.4.min.js"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
			<script src="js/vendor/bootstrap.min.js"></script>			
			<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBhOdIF3Y9382fqJYt5I_sswSrEw5eihAA"></script>
  			<script src="js/easing.min.js"></script>			
			<script src="js/hoverIntent.js"></script>
			<script src="js/superfish.min.js"></script>	
			<script src="js/jquery.ajaxchimp.min.js"></script>
			<script src="js/jquery.magnific-popup.min.js"></script>	
			<script src="js/owl.carousel.min.js"></script>			
			<script src="js/jquery.sticky.js"></script>
			<script src="js/jquery.nice-select.min.js"></script>			
			<script src="js/parallax.min.js"></script>		
			<script src="js/mail-script.js"></script>	
			<script src="js/main.js"></script>	
</body>
</html>
